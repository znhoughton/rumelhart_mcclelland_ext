---
title: "sae_analysis"
author: "Zachary Houghton"
date: "2025-12-21"
output: html_document
---

```{r setup, include=FALSE}

```

## 

```{r}
library(tidyverse)
library(purrr)
library(stringr)

data_dir <- "../Data/sae_latents_long"

model_files <- list.files(
  data_dir,
  pattern = "\\.csv$",
  full.names = TRUE
)

MODEL_TAGS <- basename(model_files) |>
  str_replace("\\.csv$", "")

MODEL_TAGS

extract_patterns_for_model <- function(model_tag,
                                       data_dir = "../Data/sae_latents_long",
                                       min_len = 1,
                                       min_wsup = 0.7,
                                       alpha = 1.25,
                                       top_k = 50) {

  input_csv <- file.path(data_dir, paste0(model_tag, ".csv"))

  message("ðŸ”Ž Processing ", model_tag)

  df <- read_csv(input_csv, show_col_types = FALSE) %>%
    mutate(
      phones = map(present_phones, ~str_split(.x, "\\s+")[[1]]),
      activation = as.numeric(activation)
    ) %>%
    filter(is.finite(activation), activation > 0)

  # ---- total number of lemmas per latent ----
  latent_item_totals <- df %>%
    group_by(latent_id) %>%
    summarise(
      total_items = n_distinct(lemma),
      .groups = "drop"
    )

  patterns <- df %>%
    select(latent_id, lemma, activation, phones) %>%
    mutate(substrings = map(phones, all_substrings)) %>%
    unnest(substrings) %>%
    transmute(
      latent_id,
      lemma,
      activation,
      pattern = substrings,
      length = str_count(pattern, " ") + 1
    ) %>%
    filter(length >= min_len) %>%
    distinct(latent_id, lemma, pattern, length, .keep_all = TRUE) %>%
    group_by(latent_id, pattern, length) %>%
    summarise(
      act_sum_in_pattern = sum(activation),
      n_verbs = n_distinct(lemma),
      .groups = "drop"
    ) %>%
    left_join(latent_item_totals, by = "latent_id") %>%
    group_by(latent_id) %>%
    mutate(
      act_total = sum(df$activation[df$latent_id == first(latent_id)]),
      w_support = act_sum_in_pattern / act_total,
      prop_items = n_verbs / total_items,   # <<â€” NEW
      score = w_support * (length ^ alpha)
    ) %>%
    ungroup() %>%
    filter(w_support >= min_wsup)

  patterns %>%
    group_by(latent_id) %>%
    slice_max(order_by = score, n = 1, with_ties = FALSE) %>%
    ungroup() %>%
    mutate(model_tag = model_tag)
}


patterns_by_model <- MODEL_TAGS %>%
  set_names() %>%
  map(extract_patterns_for_model)

patterns_all <- bind_rows(patterns_by_model)


extract_phones <- function(pattern) {
  str_split(pattern, "\\s+")[[1]]
}

latent_phone_stats <- patterns_all %>%
  mutate(phones = map(pattern, extract_phones)) %>%
  group_by(model_tag, latent_id) %>%
  summarise(
    n_phones   = length(unique(unlist(phones))),
    phones_set = list(sort(unique(unlist(phones)))),
    .groups = "drop"
  )

```


```{r}
library(ggplot2)

ggplot(latent_phone_stats, aes(x = model_tag, y = n_phones)) +
  geom_violin(trim = FALSE, fill = "gray85") +
  geom_boxplot(width = 0.15, outlier.shape = NA) +
  labs(
    x = "Model",
    y = "Number of distinct phones in latent motif",
    title = "Phone diversity per latent by model"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

```{r}
ggplot(latent_phone_stats, aes(x = n_phones)) +
  geom_histogram(binwidth = 0.5, boundary = 0, fill = "steelblue", color = "white") +
  facet_wrap(~ model_tag, scales = "free_y") +
  labs(
    x = "Number of distinct phones",
    y = "Number of latents",
    title = "Distribution of phone diversity per latent"
  ) +
  theme_minimal(base_size = 13)

```

```{r}
ggplot(latent_phone_stats, aes(x = n_phones, color = model_tag)) +
  geom_density(linewidth = 1) +
  labs(
    x = "Number of distinct phones",
    y = "Density",
    title = "Phone diversity distribution by model"
  ) +
  theme_minimal(base_size = 13)

```

